## 什么是服务治理

学习SpringCloud服务治理之前，我们先了解一下服务治理的基本概念。

**服务治理的目标**：

- 高可用性：即多微服务节点，及时海啸地震闪电，导致机房崩溃，只要有一个节点存活，就依旧能提供服务
- 分布式调用：多节点机房可能存在不同的地方，可能是跨市跨省跨国跨洲，复杂的网络环境，也可以使用服务治理实现精准调用
- 生命周期：服务的上线，持续运行以及下线，都由服务治理来管理
- 健康检查：服务节点是否因特殊情况宕机了，没有心跳了，服务治理就需要将其剔除下线，影响业务可用性，等什么时候复活了，再拉他上线

**服务治理为了目标需要解决的问题（3W1H）**：

- Who are u：服务节点想要被治理，我得知道你是谁吧？这里包括三个维度
  - IP+端口
  - 服务名称
  - 健康状态，可用还是下线
- Where are u from：这里是针对请求的，我想要请求服务，需要询问服务治理中心，获取节点的地址来请求
- How are u doing：针对服务治理中心，用于判断服务节点是否因为不可控因素宕机了，我们需要将其剔除下线
- When you die：针对服务节点，服务节点如果因为自身原因主动申请下线，需要告知服务治理中心

**那么为了解决问题，服务治理提供了哪些方案呢**？

- Who are u：服务注册 - 服务节点主动注册到服务治理中心
- Where are u from：服务发现 - 服务治理中心拉取注册信息
- How are u doing：心跳检测、服务续约、服务剔除 - 定时检测心跳，服务是否存活，如果宕机，将其剔除，如果复活，将其续约
- When you die：服务下线 - 服务节点主动下线

**服务治理的技术选型**

![image-20201016111044064](image/image-20201016111044064.png)

我们主要使用的是目前最红最火的Eureka

## 注册中心

我们了解完服务治理后，就要一点点学习其中的知识了，首当其冲的当然是注册中心，也就是上面介绍的服务治理中心，用于管理服务

### 初识注册中心

前面说到，注册中心是用来解决Who are u服务注册的问题的，获取所有节点的身份信息，服务名称以及存活状态，那么他要如何获取这么多的服务节点呢？有两种思路：

- 注册中心主动的向网络中所有机器发送消息，联系他们，看看是否需要加入到我的怀抱
- 守株待兔，等着服务自己找上门来

一般来说，几乎所有的注册中心架构实现方式都是第二种，为什么呢？

我们看看第一种有哪些弊端：

- 模型复杂；在复杂的网络世界，向所有节点发送广播，无意义对着全世界喊我爱你，看看有谁回应你，而在现实的分布式网络环境中，响应模型更加复杂
- 网络消耗大：因为要对所有节点发送广播，那肯定包含非服务节点的，无疑增加网络通信成本
- 服务端压力大：因为要对所有节点广播，如果有大量服务节点接收广播返回响应，那么服务端还需要接收响应进行操作，加大压力，因为我们注册中心并不会有很多节点高可用，一般就两三个，所以无疑影响业务

所以，我们的Eureka就是选择的第二种，建立起注册中心门户后，只需等着服务节点找上门来就可以了，它需要保存服务节点的IP，端口，服务名称，服务状态信息，当然，他自身还有其他事情要做，比如**检测服务节点心跳，判断是续约还是剔除**，注册中心一般都是多节点实现，所以还需要进行**注册信息同步**，将多个节点的服务同步，这样的好处也很明显，完全解决了上面三个弊端。

**服务节点报道**

服务节点报道时，是怎么找到注册中心，并向其注册呢？就是由我们配置注册中心的地址，所以知道往哪去注册，地址主要有三个维度：

- Region：地理上的分区，一般使用默认，当多机房环境，机房地址在不同位置时，进行配置，比如在中国，`region=east_china`
- Zone：分区下的机房，也一般使用默认，多机房环境进行配置，比如上海，配合Region，即`zone=sh`
- Url：Eureka的启动地址，例如：`http://localhost:20000/eureka/`

配置完维度后，服务找到了注册中心，需要告诉注册中心什么呢？

- 我会的服务名叫什么，我提供什么服务？`spring.application.name=user`
- 我住在哪里，我的地址：`localhost:10000`
- 其他的一些信息，后面再了解，这里大致了解一些，服务注册到注册中心，要带一些信息

### 实现注册中心

在之前21节笔记中，我们创建了一个父工程来管理SpringCloud，springboot的版本，所以我们直接在这个工程下创建module即可，创建一个eureka文件夹，在其中创建`eureka-server`的module

1.pom添加注册中心依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-server</artifactId>
    </dependency>
</dependencies>
```

只需添加eureka-server的依赖

2.创建启动器类

```java
@SpringBootApplication
@EnableEurekaServer // 注册中心
public class EurekaServerApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaServerApplication.class,args);
    }
}
```

3.添加配置文件

```yml
spring:
  application:
    name: eureka-server
server:
  port: 22222
eureka:
  instance:
    hostname: localhost # eureka节点名称
  client:
    register-with-eureka: false # 不注册自己
    fetch-registry: false # 不需要拉取服务注册表
```

启动后访问：`localhost:22222`即可看到注册中心ui页面，里面存放节点信息以及一些其他信息

## 服务注册

### 初识服务注册

学习完注册中心后，就要看看服务要怎么注册到注册中心上了。

服务注册是个高深技术，需要细品，我们先简单了解一些，SpringCloudEureka的服务注册，大概做了哪些事，用了哪些技术：

<img src="image/image-20201019112115383.png" alt="image-20201019112115383" style="zoom:67%;" />

- 扫描注解：服务注册开始，我们必须自报家门，使用`@EnableDiscoveryClient`注解，表示我们是来服务注册的
- 发起注册：扫描到我们的注解后，就开始注册拉，其中的`DiscoveryClient`类就运行起register方法，这个类是一个门面类，最外层，是很多节点的服务调用入口。此时`DiscoveryClient`使用代理+装饰器模式，转而运行`SessionedEurekaHttpClient`装饰器
- 装饰器代理：`SessionedEurekaHttpClient`还有一个大爹，`EurekaHttpClientDecorator`，Eureka的一众连接器，都是它的子孙，也就是标准的装饰器模式，就像俄罗斯套娃一样，一层比一层的buff多
- 代理注册：接下来，就是Eureka大显神通，使用加了一层层buff的装饰器，使用代理+回调的方式实现注册

通过一个笼统的概括，我们还是不太明白Eureka具体是怎么注册的，只是知道了，**Eureka注册需要添加一个注解，通过这个注解被扫描后，使用装饰器+代理的模式实现注册**

接下来我们看看实际是如何注册的，注册一击！

<img src="image/image-20201019113032640.png" alt="image-20201019113032640" style="zoom:67%;" />

- 代理模式注册：之前我们说Eureka注册，是一层层的装饰器来调用实现，那么我们就需要从`RetryableEurekaHttpClient`这个装饰器最重要的一层，来展开，我们可以发现他的名字是Retry，“失败重试”，就可以知道具有复活buff
- 获取HttpClient：这个`HttpClient`是`RetryableEurekaHttpClient`中的一个代理对象，它封装了上次我们注册成功的注册中心地址等信息，如果有，就直接再次同步注册，如果没有，就需要获取Server列表
- 获取Server列表：这里是从我们的配置文件中获取注册中心的地址
  - 如果没有，直接886，抛出异常，等下一次定时任务发起注册的时候再尝试
  - 如果有，那么获取第x台机器（注意这个x）作为目标注册机器
- 发送注册请求：这里就到了杀招。使用`JerseyApplicationCLient`装饰器的`register`方法，来实际注册到注册中心，这里回携带大量的信息，其中关键的事：我的服务名称，服务IP，节点状态
  - 注册成功？返回正确标识
  - 注册失败？你这个不行我换一个试试，这里就会重新获取Server获取第**x+1**台服务器信息，重新注册尝试；如果还是不行，当复活币使用完毕全部注册失败，就拉闸抛出异常，等下一次定时任务调用时再注册吧

### 实现注册中心

接下来我们直接实现一个注册中心，看看需要哪些东西，创建一个module，`eureka-client`

1.pom添加client依赖

```xml
<dependencies>
    <dependency>
        <groupId>org.springframework.cloud</groupId>
        <artifactId>spring-cloud-starter-netflix-eureka-client</artifactId>
    </dependency>
    <dependency>
        <groupId>org.springframework.boot</groupId>
        <artifactId>spring-boot-starter-web</artifactId>
    </dependency>
</dependencies>
```

2.创建Client启动器，并添加服务节点注解

```java
@SpringBootApplication
@EnableDiscoveryClient
public class EurekaClientApplication {
    public static void main(String[] args) {
        SpringApplication.run(EurekaClientApplication.class,args);
    }
}
```

3.添加配置，主要是注册中心的地址

```yml
spring:
  application:
    name: eureka-client
server:
  port: 33333
eureka:
  client:
    service-url:
      defaultZone: http://localhost:22222/eureka
```

这样，就可以把该服务节点注册到注册中心

![image-20201019173055867](image/image-20201019173055867.png)

